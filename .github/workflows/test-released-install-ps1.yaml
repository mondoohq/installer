name: "Test Release: install.ps1"

on:
  workflow_call:
    inputs:
      version:
        description: "Version to test"
        required: true
        default: "11.63.1"
        type: string
  workflow_dispatch:
    inputs:
      version:
        description: "Version to test"
        required: true
        default: "11.63.1"

jobs:
  wait-for-pkg:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for packages to be published (Release Event)
        id: check_release_file
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3.0.2
        with:
          retry_wait_seconds: 20
          timeout_seconds: 5
          max_attempts: 100
          retry_on: error
          # error on HTTP code different to 200
          command: |
            vSEMVER=${{ inputs.version }}
            SEMVER="${vSEMVER//v}"

            # Clear cache before checking with retry logic
            echo "Clearing minstaller's cache..."
            cache_cleared=false
            cache_max_attempts=3
            cache_attempt=1

            while [ $cache_attempt -le $cache_max_attempts ] && [ "$cache_cleared" = false ]; do
              echo "Cache clear attempt $cache_attempt/$cache_max_attempts..."

              cache_response=$(curl -s -w "HTTP_CODE:%{http_code}" \
                -X POST https://install.mondoo.com/_/cache/clear-all \
                -H "X-API-Key: ${{ secrets.MINSTALLER_API_KEY }}" 2>/dev/null || true)

              if echo "$cache_response" | grep -q "HTTP_CODE:200"; then
                echo "âœ… Cache cleared successfully on attempt $cache_attempt"
                cache_cleared=true
              else
                echo "âš ï¸ Cache clear attempt $cache_attempt failed..."
                if [ $cache_attempt -lt $cache_max_attempts ]; then
                  echo "Waiting 5 seconds before retry..."
                  sleep 5
                fi
              fi

              cache_attempt=$((cache_attempt + 1))
            done

            if [ "$cache_cleared" = false ]; then
              echo "âš ï¸ Cache clear failed after $cache_max_attempts attempts, continuing anyway..."
            fi

            # Check if all packages are available
            packages_to_check="mondoo:msi cnquery:zip cnspec:zip"
            failed_packages=""

            for package_info in $packages_to_check; do
              package_name=$(echo $package_info | cut -d: -f1)
              package_format=$(echo $package_info | cut -d: -f2)
              
              echo "Checking $package_name ($package_format)..."
              http_code=$(curl -o /dev/null -s -w "%{http_code}\n" \
                "https://install.mondoo.com/package/${package_name}/windows/amd64/${package_format}/${SEMVER}/sha256")

              if [ "$http_code" = "200" ]; then
                echo "âœ… $package_name is available"
              else
                echo "âŒ $package_name failed (HTTP $http_code)"
                failed_packages="$failed_packages $package_name"
              fi
            done

            if [ -n "$failed_packages" ]; then
              echo "Failed packages:$failed_packages"
              exit 1
            fi

            echo "ðŸŽ‰ All packages are available!"

  clear-cache:
    if: always()
    uses: ./.github/workflows/clear-minstaller-cache.yaml
    needs: wait-for-pkg
    secrets:
      MINSTALLER_API_KEY: ${{ secrets.MINSTALLER_API_KEY }}

  install-ps1-windows:
    runs-on: windows-latest
    needs: clear-cache
    strategy:
      matrix:
        os: ["windows-latest"]
        package: ["cnquery", "cnspec"]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Version
        id: version
        run: |
          $v='${{ inputs.version }}'
          $version=$v.trim("v","V")
          echo "version=$version" >> $env:GITHUB_OUTPUT
      - name: Install.ps1/${{ matrix.package }} on ${{ matrix.os }}
        run: |
          Set-ExecutionPolicy Unrestricted -Scope Process -Force;
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072;
          iex ((New-Object System.Net.WebClient).DownloadString('https://install.mondoo.com/ps1/${{ matrix.package }}'));
          Install-Mondoo -Product ${{ matrix.package }};
      - name: Verify the correct version is installed
        shell: pwsh
        run: |
          # Logic to validate version has been moved to separate file
          ./test/powershell/verify-cnspec-version.ps1 -ExpectedVersion "${{ steps.version.outputs.version }}"  -BinaryBaseName "${{ matrix.package }}"

  install-ps1-windows-mondoo:
    runs-on: windows-latest
    needs: clear-cache
    strategy:
      matrix:
        os: ["windows-latest"]
        package: ["mondoo"]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Version
        id: version
        run: |
          $v='${{ inputs.version }}'
          $version=$v.trim("v","V")
          echo "version=$version" >> $env:GITHUB_OUTPUT
      - name: Install.ps1/${{ matrix.package }} on ${{ matrix.os }}
        run: |
          Set-ExecutionPolicy Unrestricted -Scope Process -Force;
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072;
          iex ((New-Object System.Net.WebClient).DownloadString('https://install.mondoo.com/ps1/${{ matrix.package }}'));
          Install-Mondoo -Product ${{ matrix.package }};
      - name: Verify the correct version is installed
        shell: pwsh
        run: |
          # Logic to validate version has been moved to separate file
          ./test/powershell/verify-cnspec-version.ps1 -ExpectedVersion "${{ steps.version.outputs.version }}"
