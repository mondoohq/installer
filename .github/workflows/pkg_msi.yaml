name: "PKG: Microsoft Software Installer (MSI)"

on:
  workflow_call:
    inputs:
      version:
        description: "Package Version"
        required: true
        default: "0.0.1"
        type: "string"
      skip-publish:
        description: "Skip publish?"
        required: false
        default: false
        type: boolean
      bucket:
        description: "GCP Release Bucket Name"
        required: true
        default: "releases-us.mondoo.io"
        type: string
      use-test-cert:
        description: "Use test certificate profile (not publicly trusted)"
        required: false
        default: false
        type: boolean
  workflow_dispatch:
    inputs:
      version:
        description: "Package Version"
        required: true
        default: "0.0.1"
        type: "string"
      skip-publish:
        description: "Skip publish?"
        required: false
        default: false
        type: boolean
      bucket:
        description: "GCP Release Bucket Name"
        required: true
        default: "releases-us.mondoo.io"
        type: string
      use-test-cert:
        description: "Use test certificate profile (not publicly trusted)"
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  setup:
    name: "Setup"
    runs-on: ubuntu-latest
    steps:
      - name: Dump all inputs
        run: echo "${{ toJSON(inputs) }}"

      - name: Ensure version of cnquery and cnspec are available
        run: |
          # Function to check URL with retry logic
          check_url_with_retry() {
            local url="$1"
            local max_attempts=3
            local wait_time=5

            for attempt in $(seq 1 $max_attempts); do
              echo "Attempt $attempt of $max_attempts: Checking $url"
              if curl -sL --head --location --fail --connect-timeout 30 --max-time 60 --retry 2 --retry-delay 3 \
                "$url" > /dev/null; then
                echo "✓ Available: $(basename "$url")"
                return 0
              else
                echo "✗ Failed to access: $(basename "$url") (attempt $attempt)"
                if [ $attempt -lt $max_attempts ]; then
                  echo "Waiting $wait_time seconds before retry..."
                  sleep $wait_time
                fi
              fi
            done
            echo "ERROR: Failed to access $url after $max_attempts attempts"
            return 1
          }

          # Check all required URLs
          urls=(
            "https://github.com/mondoohq/cnquery/releases/download/v${{ inputs.version }}/cnquery_${{ inputs.version }}_windows_amd64.zip"
            "https://github.com/mondoohq/cnspec/releases/download/v${{ inputs.version }}/cnspec_${{ inputs.version }}_windows_amd64.zip"
            "https://github.com/mondoohq/cnquery/releases/download/v${{ inputs.version }}/cnquery_${{ inputs.version }}_windows_arm64.zip"
            "https://github.com/mondoohq/cnspec/releases/download/v${{ inputs.version }}/cnspec_${{ inputs.version }}_windows_arm64.zip"
            "https://github.com/mondoohq/cnquery/releases/download/v${{ inputs.version }}/cnquery_v${{ inputs.version }}_SHA256SUMS"
            "https://github.com/mondoohq/cnspec/releases/download/v${{ inputs.version }}/cnspec_v${{ inputs.version }}_SHA256SUMS"
          )

          failed=0
          for url in "${urls[@]}"; do
            if ! check_url_with_retry "$url"; then
              failed=1
            fi
          done

          if [ $failed -eq 1 ]; then
            echo "ERROR: One or more required binaries are not available"
            exit 1
          fi

          echo "✓ All required binaries are available for version ${{ inputs.version }}"

  dist-prepare:
    name: Prepare Distribution for Packaging
    strategy:
      matrix:
        arch:
          - amd64
          - arm64
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Download, Verify and Extract the Binaries
        env:
          VERSION: ${{ inputs.version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create directory and enter it
          mkdir -p dist/${{ matrix.arch }} && cd dist/${{ matrix.arch }}

          # Function to download with retry logic
          download_with_retry() {
            local url="$1"
            local filename="$2"
            local max_attempts=3
            local wait_time=10

            for attempt in $(seq 1 $max_attempts); do
              echo "Attempt $attempt of $max_attempts: Downloading $filename"
              if curl -sSL --fail-with-body --connect-timeout 30 --max-time 300 --retry 3 --retry-delay 5 \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/octet-stream" \
                -o "$filename" \
                "$url"; then
                echo "Successfully downloaded $filename"
                return 0
              else
                echo "Download failed for $filename (attempt $attempt)"
                if [ $attempt -lt $max_attempts ]; then
                  echo "Waiting $wait_time seconds before retry..."
                  sleep $wait_time
                fi
              fi
            done
            echo "ERROR: Failed to download $filename after $max_attempts attempts"
            return 1
          }

          # Download checksums for validation
          if ! download_with_retry "https://github.com/mondoohq/cnspec/releases/download/v${VERSION}/cnspec_v${VERSION}_SHA256SUMS" "cnspec_v${VERSION}_SHA256SUMS"; then
            exit 1
          fi
          if ! download_with_retry "https://github.com/mondoohq/cnquery/releases/download/v${VERSION}/cnquery_v${VERSION}_SHA256SUMS" "cnquery_v${VERSION}_SHA256SUMS"; then
            exit 1
          fi

          # Download cnspec
          if ! download_with_retry "https://github.com/mondoohq/cnspec/releases/download/v${VERSION}/cnspec_${VERSION}_windows_${{ matrix.arch }}.zip" "cnspec_${VERSION}_windows_${{ matrix.arch }}.zip"; then
            exit 1
          fi

          # Validate cnspec checksum
          expected_checksum=$(grep "cnspec_${VERSION}_windows_${{ matrix.arch }}.zip" cnspec_v${VERSION}_SHA256SUMS | awk '{print $1}')
          if [ -z "$expected_checksum" ]; then
            echo "ERROR: Could not find expected checksum for cnspec_${VERSION}_windows_${{ matrix.arch }}.zip"
            exit 1
          fi
          actual_checksum=$(sha256sum "cnspec_${VERSION}_windows_${{ matrix.arch }}.zip" | awk '{print $1}')
          if [ "$actual_checksum" != "$expected_checksum" ]; then
            echo "ERROR: Checksum mismatch for cnspec binary"
            echo "Expected: $expected_checksum"
            echo "Actual: $actual_checksum"
            exit 1
          fi
          echo "✓ cnspec checksum validated successfully"

          # Extract and cleanup cnspec
          if ! unzip cnspec_${VERSION}_windows_${{ matrix.arch }}.zip; then
            echo "ERROR: Failed to extract cnspec binary"
            exit 1
          fi
          rm cnspec_${VERSION}_windows_${{ matrix.arch }}.zip cnspec_v${VERSION}_SHA256SUMS

          # Download cnquery
          if ! download_with_retry "https://github.com/mondoohq/cnquery/releases/download/v${VERSION}/cnquery_${VERSION}_windows_${{ matrix.arch }}.zip" "cnquery_${VERSION}_windows_${{ matrix.arch }}.zip"; then
            exit 1
          fi

          # Validate cnquery checksum
          expected_checksum=$(grep "cnquery_${VERSION}_windows_${{ matrix.arch }}.zip" cnquery_v${VERSION}_SHA256SUMS | awk '{print $1}')
          if [ -z "$expected_checksum" ]; then
            echo "ERROR: Could not find expected checksum for cnquery_${VERSION}_windows_${{ matrix.arch }}.zip"
            exit 1
          fi
          actual_checksum=$(sha256sum "cnquery_${VERSION}_windows_${{ matrix.arch }}.zip" | awk '{print $1}')
          if [ "$actual_checksum" != "$expected_checksum" ]; then
            echo "ERROR: Checksum mismatch for cnquery binary"
            echo "Expected: $expected_checksum"
            echo "Actual: $actual_checksum"
            exit 1
          fi
          echo "✓ cnquery checksum validated successfully"

          # Extract and cleanup cnquery
          if ! unzip cnquery_${VERSION}_windows_${{ matrix.arch }}.zip; then
            echo "ERROR: Failed to extract cnquery binary"
            exit 1
          fi
          rm cnquery_${VERSION}_windows_${{ matrix.arch }}.zip cnquery_v${VERSION}_SHA256SUMS

          echo "Successfully downloaded and extracted binaries:"
          ls -lh
      - name: Upload Distribution
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: dist-${{ matrix.arch }}
          path: dist/${{ matrix.arch }}
          retention-days: 7

  msi-build:
    name: "Packaging: Windows MSI"
    environment: prod
    runs-on: windows-2025
    strategy:
      matrix:
        arch:
          - amd64
          - arm64
    needs:
      - setup
      - dist-prepare
    #  For Version: ${{ inputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download Distribution
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: dist-${{ matrix.arch }}
          path: dist/${{ matrix.arch }}

      - name: Build MSI
        env:
          VERSION: ${{ inputs.version }}
        run: |
          $mondooVersion = ${env:VERSION}
          echo "Running build job for version ${mondooVersion}"
          Copy-Item .\dist\${{ matrix.arch }}\cnquery.exe .\packages\msi\msi\
          Copy-Item .\dist\${{ matrix.arch }}\cnspec.exe .\packages\msi\msi\
          Copy-Item .\dist\${{ matrix.arch }}\cnquery.exe .\packages\msi\appx\
          Copy-Item .\dist\${{ matrix.arch }}\cnspec.exe .\packages\msi\appx\
          # build msi package
          echo " - Packaging MSI..."
          Set-Location -Path '.\packages\msi\'
          ./package.ps1 -version $mondooVersion -arch ${{ matrix.arch }}

      - name: Azure login
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
        with:
          client-id: ${{ secrets.TSIGN_AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.TSIGN_AZURE_TENANT_ID}}
          subscription-id: ${{ vars.TSIGN_AZURE_SUBSCRIPTION_ID }}

      - name: Sign files with Trusted Signing
        uses: azure/artifact-signing-action@db7a3a6bd3912025c705162fb7475389f5b69ec6 # v1.0.0
        with:
          endpoint: ${{ vars.TSIGN_AZURE_ENDPOINT }}
          signing-account-name: ${{ vars.TSIGN_ACCOUNT_NAME }}
          # Conditional logic for switching certificate-profile-name type
          certificate-profile-name: ${{ inputs.use-test-cert == true && vars.TSIGN_TEST_CERT_PROFILE_NAME || vars.TSIGN_CERT_PROFILE_NAME }}
          files: |
            ${{ github.workspace }}\packages\msi\mondoo_${{ matrix.arch }}.msi
          file-digest: SHA256
          timestamp-rfc3161: http://timestamp.acs.microsoft.com
          timestamp-digest: SHA384
          exclude-environment-credential: true
          exclude-workload-identity-credential: true
          exclude-managed-identity-credential: true
          exclude-shared-token-cache-credential: true
          exclude-visual-studio-credential: true
          exclude-visual-studio-code-credential: true
          exclude-azure-cli-credential: false
          exclude-azure-powershell-credential: true
          exclude-azure-developer-cli-credential: true
          exclude-interactive-browser-credential: true
          cache-dependencies: true

      - name: Cleanup dist before upload
        run: |
          Copy-Item '.\packages\msi\mondoo_${{ matrix.arch }}.msi' '.\dist\${{ matrix.arch }}'
          Remove-Item -Path .\dist\${{ matrix.arch }}\cnquery.exe -Force
          Remove-Item -Path .\dist\${{ matrix.arch }}\cnspec.exe -Force

      - name: Upload Distribution
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: msi-${{ matrix.arch }}
          path: dist/${{ matrix.arch }}
          retention-days: 7

  test-msi-install:
    name: Test Signed Package
    strategy:
      matrix:
        arch:
          - amd64
    #          - arm64 # we currently don't have windows arm64 runners to test arm against
    needs:
      - setup
      - msi-build
    runs-on: windows-2025
    steps:
      - name: Download MSI Package
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: msi-${{ matrix.arch }}
          path: dist
      - name: Verify Signed MSI Status
        if: ${{ inputs.use-test-cert == false }}
        shell: powershell
        run: |
          $msiFileName = "mondoo_${{ matrix.arch }}.msi"
          $msiFilePath = Join-Path -Path (Get-Location) -ChildPath "dist\$msiFileName"

          Write-Host "Attempting to verify digital signature for MSI: $msiFilePath"

          # --- Pre-check: Ensure the file exists ---
          if (-not (Test-Path $msiFilePath)) {
              Write-Error "Error: MSI file not found at '$msiFilePath'. Cannot verify signature."
              exit 1 # Fail the step if the file is missing
          }

          # --- Signature Verification ---
          try {
              $signature = Get-AuthenticodeSignature -FilePath $msiFilePath

              Write-Host "Signature Status: $($signature.Status)"

              if ($signature.Status -eq "Valid") {
                  Write-Host "Success: The MSI has a valid signature."
                  Write-Host "Signed by: $($signature.SignerCertificate.Subject)"
                  Write-Host "Issued by: $($signature.SignerCertificate.Issuer)"
                  Write-Host "Valid From: $($signature.SignerCertificate.NotBefore)"
                  Write-Host "Valid To: $($signature.SignerCertificate.NotAfter)"
              }
              else {
                  # For any status other than 'Valid', treat as a failure
                  Write-Error "Error: MSI signature verification failed or is not valid. Status: $($signature.Status)"

                  # Provide more context for common non-valid statuses
                  if ($signature.Status -eq "NotSigned") {
                      Write-Error "Reason: The MSI is not digitally signed."
                  } elseif ($signature.Status -eq "HashMismatch") {
                      Write-Error "Reason: The file has been tampered with since signing (hash mismatch)."
                  } elseif ($signature.Status -eq "Untrusted") {
                      Write-Error "Reason: The certificate chain could not be built to a trusted root authority."
                      # Output details of the certificate if untrusted, for debugging
                      Write-Host "Untrusted Certificate Subject: $($signature.SignerCertificate.Subject)"
                      Write-Host "Untrusted Certificate Thumbprint: $($signature.SignerCertificate.Thumbprint)"
                  } elseif ($signature.Status -eq "UnknownError") {
                      Write-Error "Reason: An unknown error occurred during signature verification."
                  }

                  exit 1 # Fail the step
              }
          }
          catch {
              Write-Error "An unexpected error occurred during signature verification: $($_.Exception.Message)"
              exit 1 # Fail the step
          }
      - name: Install artifact
        run: |
          $TEMP_PATH = $env:TEMP
          cd dist
          $msiexec = Start-Process "msiexec" "/i mondoo_${{ matrix.arch }}.msi /qn /l*! install.log" -NoNewWindow -PassThru
          $gci = Start-Process "powershell" "Get-Content -Path install.log -Wait" -NoNewWindow -PassThru
          $msiexec.WaitForExit() 
          $gci.Kill()
          gci
      - name: Verify the correct cnquery version is installed
        run: |
          $version=& 'C:\Program Files\Mondoo\cnquery.exe' version
          Write-Output "comparing $version -like '*${{ inputs.version }}*'"
          $match=$version -like "*${{ inputs.version }}*"
          if (-not $match) {
            exit 1
          }
      - name: Run a basic cnquery sanity check
        run: |
          & 'C:\Program Files\Mondoo\cnquery.exe' run -c "os.base.packages.where(name == 'Mondoo') { name }"
      - name: Verify the correct cnspec version is installed
        run: |
          $version=& 'C:\Program Files\Mondoo\cnspec.exe' version
          Write-Output "comparing $version -like '*${{ inputs.version }}*'"
          $match=$version -like "*${{ inputs.version }}*"
          if (-not $match) {
            exit 1
          }
      - name: Run a basic cnspec sanity check
        run: |
          & 'C:\Program Files\Mondoo\cnspec.exe' run -c "os.base.packages.where(name == 'Mondoo') { name }"
      - name: Login to edge with cnspec
        run: |
          & 'C:\Program Files\Mondoo\cnspec.exe' login -t "${{ secrets.INSTALL_TEST_MONDOO_REGISTRATION_TOKEN }}" --config C:\ProgramData\Mondoo\mondoo.yml
      - name: Run a basic cnspec sanity check
        run: |
          & 'C:\Program Files\Mondoo\cnspec.exe' policy download mondoo-windows-installer -f mondoo-windows-installer.mql.yaml
          & 'C:\Program Files\Mondoo\cnspec.exe' scan local --detect-cicd --score-threshold 100 -o full --policy-bundle mondoo-windows-installer.mql.yaml
      - name: Logout from edge with cnspec
        run: |
          & 'C:\Program Files\Mondoo\cnspec.exe' logout --config C:\ProgramData\Mondoo\mondoo.yml --force

  publish:
    name: "Publish: Releases"
    if: ${{ inputs.skip-publish == false }}
    strategy:
      matrix:
        arch:
          - amd64
          - arm64
    needs:
      - setup
      - msi-build
      - test-msi-install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Download MSI Package
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: msi-${{ matrix.arch }}
          path: dist
      - name: Authenticate with Google Cloud
        id: gauth
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
        with:
          credentials_json: ${{secrets.GCP_CREDENTIALS}}
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # v3.0.1
      - name: Verify access to release bucket
        env:
          VERSION: ${{ inputs.version }}
        run: |
          gsutil ls gs://${{ inputs.bucket }}/mondoo
      - name: Upload static content to buckets
        env:
          VERSION: ${{ inputs.version }}
          SKIP: ${{ inputs.skip-publish && 'echo skipping...' || '' }}
        run: |
          cd dist
          mv mondoo_${{ matrix.arch }}.msi mondoo_${VERSION}_windows_${{ matrix.arch }}.msi
          sha256sum mondoo_${VERSION}_windows_${{ matrix.arch }}.msi >> checksums.windows_${{ matrix.arch }}.txt
          $SKIP gsutil cp checksums.windows_${{ matrix.arch }}.txt gs://${{ inputs.bucket }}/mondoo/${VERSION}/checksums.windows_${{ matrix.arch }}.txt
          $SKIP gsutil cp mondoo_${VERSION}_windows_${{ matrix.arch }}.msi gs://${{ inputs.bucket }}/mondoo/${VERSION}/mondoo_${VERSION}_windows_${{ matrix.arch }}.msi
      - name: Cleanup
        run: |
          rm -f "${{ steps.gauth.outputs.credentials_file_path }}"
